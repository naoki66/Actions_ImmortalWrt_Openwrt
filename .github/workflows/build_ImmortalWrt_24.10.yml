# .github/workflows/compile_immortalwrt_openwrt_24_10.yml
name: ç¼–è¯‘ immortalwrt openwrtâ€‘24.10

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '20 2 * * 2'

env:
  TZ: Asia/Shanghai
  DEBIAN_FRONTEND: noninteractive
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x64.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh

concurrency:
  group: build-openwrt-24.10
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      actions: write

    steps:
      - name: æ£€å‡º Workflow ä»“åº“
        uses: actions/checkout@v4.2.2
        with:
          path: workflow
          fetch-depth: 1

      - name: è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y --no-install-recommends \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 \
            ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp nano ninja-build p7zip p7zip-full \
            patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons \
            squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev zstd
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir && sudo chown $USER:$GROUPS /workdir
          echo "TIME_START=$(date '+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†')" >> $GITHUB_ENV
          echo "TIME_EPOCH_START=$(date +%s)" >> $GITHUB_ENV

      - name: å…‹éš† ImmortalWrt æºç 
        working-directory: /workdir
        run: |
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          [ -L $GITHUB_WORKSPACE/openwrt ] || ln -s /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: æ¢å¤ DL ç¼“å­˜
        uses: actions/cache@v4.2.3
        with:
          path: /workdir/openwrt/dl
          key: dl-openwrt-24.10

      - name: æ¢å¤ Feeds ç¼“å­˜
        uses: actions/cache@v4.2.3
        with:
          path: /workdir/openwrt/feeds
          key: feeds-${{ hashFiles('workflow/' + env.FEEDS_CONF, 'workflow/' + env.DIY_P1_SH) }}
          restore-keys: feeds-

      - name: åº”ç”¨è‡ªå®šä¹‰ Feeds ä¸è„šæœ¬
        run: |
          [ -e workflow/$FEEDS_CONF ] && cp workflow/$FEEDS_CONF /workdir/openwrt/feeds.conf.default
          chmod +x workflow/$DIY_P1_SH
          pushd /workdir/openwrt
          $GITHUB_WORKSPACE/workflow/$DIY_P1_SH
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          popd

      - name: ç”Ÿæˆä¸Šæ¸¸æ›´æ–°æ—¥å¿—ï¼ˆgitÂ logï¼‰
        run: |
          mkdir -p /workdir/changelog
          cd /workdir/openwrt

          # æ‹‰å–æœ€è¿‘ 30 æ¡å†å²
          git fetch --deepen=30 || true
          git -C feeds/packages fetch --deepen=30 || true
          git -C feeds/luci     fetch --deepen=30 || true

          LOG_BASE=$(git log --date=short --pretty="- [%ad] %s" --no-merges -n 15)
          LOG_PKG=$(git -C feeds/packages log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/packages ä¸æ˜¯ git ä»“åº“")
          LOG_LUCI=$(git -C feeds/luci log --date=short --pretty="- [%ad] %s" --no-merges -n 10 || echo "feeds/luci ä¸æ˜¯ git ä»“åº“")

          {
            echo "ğŸ“¦ openwrt-24.10 åˆ†æ”¯ä¸Šæ¸¸æ›´æ–°æ—¥å¿—"
            echo
            echo "### immortalwrtï¼ˆæœ€è¿‘ 15 æ¡ï¼‰"
            echo "$LOG_BASE"
            echo
            echo "### packagesï¼ˆæœ€è¿‘ 10 æ¡ï¼‰"
            echo "$LOG_PKG"
            echo
            echo "### luciï¼ˆæœ€è¿‘ 10 æ¡ï¼‰"
            echo "$LOG_LUCI"
          } > /workdir/changelog/complete_changelog.txt

      - name: ä¸Šä¼ æ›´æ–°æ—¥å¿—äº§ç‰©
        uses: actions/upload-artifact@v4.6.2
        with:
          name: changelog
          path: /workdir/changelog/complete_changelog.txt

      - name: åŠ è½½é…ç½®å¹¶æ‰§è¡Œ DIYâ€‘part2
        run: |
          [ -e workflow/files ] && cp -r workflow/files /workdir/openwrt/
          [ -e workflow/$CONFIG_FILE ] && cp workflow/$CONFIG_FILE /workdir/openwrt/.config
          chmod +x workflow/$DIY_P2_SH
          pushd /workdir/openwrt
          $GITHUB_WORKSPACE/workflow/$DIY_P2_SH
          popd

      - name: ä¸‹è½½æºä»£ç åŒ…
        working-directory: /workdir/openwrt
        run: |
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -delete

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        working-directory: /workdir/openwrt
        run: |
          mkdir -p logs
          CORES=$(nproc)
          echo "ä½¿ç”¨ $CORES çº¿ç¨‹å¼€å§‹ç¼–è¯‘"
          make -j$CORES > logs/build.log 2>&1 || make -j1 V=s >> logs/build.log 2>&1
          echo "TIME_END=$(date '+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†')" >> $GITHUB_ENV

      - name: æ„å»ºå¤±è´¥æ—¶ä¸Šä¼ æ—¥å¿—
        if: failure()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: build-log
          path: /workdir/openwrt/logs/

      - name: è®¡ç®—æ„å»ºè€—æ—¶
        if: always()
        run: |
          TIME_EPOCH_END=$(date +%s)
          echo "TIME_EPOCH_END=$TIME_EPOCH_END" >> $GITHUB_ENV
          DURATION=$((TIME_EPOCH_END - TIME_EPOCH_START))
          D_H=$((DURATION / 3600))
          D_M=$(((DURATION % 3600) / 60))
          D_S=$((DURATION % 60))
          echo "TIME_DURATION=${D_H}æ—¶${D_M}åˆ†${D_S}ç§’" >> $GITHUB_ENV

      - name: æ•´ç†è¾“å‡ºè·¯å¾„
        id: organize
        run: |
          FIRMWARE_DIR=$(find /workdir/openwrt/bin/targets -type f -name '*.img*' -print -quit | xargs -I {} dirname {})
          echo "FIRMWARE_DIR=$FIRMWARE_DIR" >> $GITHUB_ENV

      - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
        uses: actions/upload-artifact@v4.6.2
        with:
          name: openwrt-24.10-${{ github.run_number }}
          path: ${{ env.FIRMWARE_DIR }}

      - name: åˆ›å»º GitHub å‘å¸ƒç‰ˆæœ¬
        uses: softprops/action-gh-release@v2.3.2
        with:
          token: ${{ secrets.ACTIONS_TRIGGER_PAT }}
          tag_name: openwrt-24.10-${{ github.run_number }}
          body_path: /workdir/changelog/complete_changelog.txt
          files: ${{ env.FIRMWARE_DIR }}/*

      - name: æ¸…ç†æ—§ Workflow è®°å½•
        uses: Mattraks/delete-workflow-runs@v2.0.6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 2
          keep_minimum_runs: 3

      - name: æ¸…ç†æ—§ Release
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 15
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.ACTIONS_TRIGGER_PAT }}

      - name: å‘é€ Pushplus é€šçŸ¥
        run: |
          curl -s http://www.pushplus.plus/send -X POST -H "Content-Type: application/json" -d '{
            "title":"GitHub Actions ç¼–è¯‘ immortalwrtâ€‘24.10 å®Œæˆ!",
            "content":"å¼€å§‹æ—¶é—´: ${{ env.TIME_START }}<br/>ç»“æŸæ—¶é—´: ${{ env.TIME_END }}<br/>è€—æ—¶: ${{ env.TIME_DURATION }}<br/><br/>æºç æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ Release æˆ–é™„ä»¶ã€‚",
            "token":"${{ secrets.PUSHPLUS_TOKEN }}",
            "channel":"cp"
          }'
